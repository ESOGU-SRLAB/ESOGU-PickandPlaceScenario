<?xml version="1.0"?>
<robot name="agv_macros" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Constants -->
  <property name="M_PI" value="3.1415926535897931" />

  <!-- ================== BASE ================== -->
  <xacro:macro name="agv_base">

    <link name="agv_base_link">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <visual>
        <origin xyz="0 0 -0.1625" rpy="0 0 0"/>
        <geometry>
          <mesh filename="file:////home/cem/colcon_ws/src/agv_description/meshes/OTAv07_meshes/OTA-v0.7.stl"
                scale="0.01 0.01 0.01"/>
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 -0.075" rpy="0 0 0"/>
        <geometry>
          <box size="1.02 0.72 0.14"/>
        </geometry>
      </collision>
      <xacro:box_inertial x="1.02605" y="0.728" z="0.3" mass="1.0"/>
    </link>

    <!-- Material -->
    <plugin name="base_material_plugin" filename="gz-sim-visual-system">
      <link_name>agv_base_link</link_name>
      <material>Gazebo/Orange</material>
    </plugin>

    <!-- Laser (Ignition sensor) -->
    <link name="scan_link">
      <visual>
        <origin xyz="0 0 0" rpy="1.570796 0 -1.570796"/>
        <geometry>
          <mesh filename="file:////home/cem/colcon_ws/src/agv_description/meshes/OTAv07_meshes/S30B-XXXXXX.stl"
                scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
    </link>

    <joint name="scan_joint" type="fixed">
      <origin xyz="0.42 0.0 0.01" rpy="0 0 0"/>
      <parent link="agv_base_link"/>
      <child link="scan_link"/>
    </joint>

    <plugin name="laser_sensor_plugin" filename="gz-sim-sensors-system">
      <sensor name="laser_scan" type="gpu_ray">
        <update_rate>40</update_rate>
        <topic>/laser</topic>
        <ray>
          <scan>
            <horizontal>
              <samples>720</samples>
              <resolution>1</resolution>
              <min_angle>-1.570796</min_angle>
              <max_angle>1.570796</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>0.1</min>
            <max>30.0</max>
            <resolution>0.03</resolution>
          </range>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.01</stddev>
          </noise>
        </ray>
      </sensor>
    </plugin>

    <!-- Camera -->
    <link name="zed_camera">
      <visual>
        <geometry>
          <mesh filename="file:////home/cem/colcon_ws/src/agv_description/meshes/OTAv07_meshes/zed.stl"/>
        </geometry>
      </visual>
    </link>

    <joint name="zed_camera_joint" type="fixed">
      <parent link="agv_base_link"/>
      <child link="zed_camera"/>
      <origin xyz="0.49 0 0.175" rpy="0 0 0"/>
    </joint>

    <plugin name="zed_camera_plugin" filename="gz-sim-sensors-system">
      <sensor name="camera_sensor" type="camera">
        <update_rate>30</update_rate>
        <topic>/camera/image_raw</topic>
        <camera>
          <horizontal_fov>1.3962634</horizontal_fov>
          <image>
            <width>640</width>
            <height>480</height>
            <format>R8G8B8</format>
          </image>
          <clip>
            <near>0.02</near>
            <far>300</far>
          </clip>
        </camera>
      </sensor>
    </plugin>

    <!-- IMU link -->
    <link name="imu_link"/>
    <joint name="imu_joint" type="fixed">
      <parent link="agv_base_link"/>
      <child link="imu_link"/>
      <origin xyz="0.0 0 0.068" rpy="0 0 0"/>
    </joint>

  </xacro:macro>

  <!-- ================== WHEEL ================== -->
  <xacro:macro name="agv_wheel" params="xyz_hub rpy_hub side">
    <link name="wheel_${side}_link">
      <visual>
        <geometry>
          <mesh filename="file:////home/cem/colcon_ws/src/agv_description/meshes/OTAv07_meshes/AnaTeker.stl"
                scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <geometry>
          <cylinder radius="0.1" length="0.05"/>
        </geometry>
      </collision>
      <xacro:cylinder_inertial radius="0.15" length="0.02" mass="0.1"/>
    </link>

    <joint name="wheel_${side}_base" type="continuous">
      <origin xyz="${xyz_hub}" rpy="${rpy_hub}"/>
      <parent link="agv_base_link"/>
      <child link="wheel_${side}_link"/>
      <axis xyz="0 1 0"/>
    </joint>

    <plugin name="wheel_${side}_visual_plugin" filename="gz-sim-visual-system">
      <link_name>wheel_${side}_link</link_name>
      <material>Gazebo/Green</material>
    </plugin>
  </xacro:macro>

  <!-- ================== CASTER ================== -->
  <xacro:macro name="agv_swivel" params="xyz_caster rpy_caster side">
    <link name="caster_${side}_link">
      <visual>
        <geometry>
          <mesh filename="file:////home/cem/colcon_ws/src/agv_description/meshes/OTAv07_meshes/SarhosTeker.stl"
                scale="0.001 0.001 0.001"/>
        </geometry>
      </visual>
      <collision>
        <geometry>
          <cylinder radius="0.005" length="0.07"/>
        </geometry>
      </collision>
      <xacro:cylinder_inertial radius="0.005" length="0.07" mass="0.1"/>
    </link>

    <joint name="caster_${side}_joint" type="continuous">
      <origin xyz="${xyz_caster}" rpy="${rpy_caster}"/>
      <axis xyz="0 0 1"/>
      <parent link="agv_base_link"/>
      <child link="caster_${side}_link"/>
    </joint>

    <plugin name="caster_${side}_visual_plugin" filename="gz-sim-visual-system">
      <link_name>caster_${side}_link</link_name>
      <material>Gazebo/Gray</material>
    </plugin>
  </xacro:macro>

  <!-- ================== IR SENSOR ================== -->
  <xacro:macro name="agv_ir" params="agv_base_link link_name xyz_ir rpy_ir">
    <link name="${link_name}_link">
      <visual>
        <geometry>
          <mesh filename="file:////home/cem/colcon_ws/src/agv_description/meshes/OTAv07_meshes/FotoelektrikSensor.stl"
                scale="0.0015 0.0015 0.0015"/>
        </geometry>
      </visual>
      <collision>
        <geometry>
          <box size="0.01 0.01 0.01"/>
        </geometry>
      </collision>
      <xacro:box_inertial x="0.01" y="0.01" z="0.01" mass="0.001"/>
    </link>

    <joint name="${link_name}_joint" type="fixed">
      <origin xyz="${xyz_ir}" rpy="${rpy_ir}"/>
      <parent link="${agv_base_link}"/>
      <child link="${link_name}_link"/>
    </joint>

    <plugin name="${link_name}_sensor_plugin" filename="gz-sim-sensors-system">
      <sensor name="${link_name}_sensor" type="gpu_ray">
        <update_rate>4</update_rate>
        <topic>/${link_name}</topic>
        <ray>
          <scan>
            <horizontal>
              <samples>320</samples>
              <resolution>1</resolution>
              <min_angle>-0.001</min_angle>
              <max_angle>0.001</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>0.02</min>
            <max>5.0</max>
            <resolution>0.01</resolution>
          </range>
        </ray>
      </sensor>
    </plugin>
  </xacro:macro>

  <!-- ================== PLUGINS ================== -->
  <xacro:macro name="agv_joints_state_publisher">
    <plugin name="joint_state_publisher" filename="gz-sim-joint-state-publisher-system">
      <update_rate>10</update_rate>
      <topic>/joint_states</topic>
    </plugin>
  </xacro:macro>

  <xacro:macro name="agv_diff_drive">
    <plugin name="differential_drive_plugin" filename="gz-sim-diff-drive-system">
      <left_joint>wheel_left_base</left_joint>
      <right_joint>wheel_right_base</right_joint>
      <wheel_separation>0.60</wheel_separation>
      <wheel_radius>0.10</wheel_radius>
      <cmd_vel_topic>/cmd_vel</cmd_vel_topic>
      <odom_topic>/odom</odom_topic>
      <odom_frame>odom</odom_frame>
      <robot_base_frame>agv_base_link</robot_base_frame>
      <publish_odometry>true</publish_odometry>
      <publish_tf>true</publish_tf>
      <update_rate>100</update_rate>
    </plugin>
  </xacro:macro>

  <xacro:macro name="agv_imu">
    <plugin name="imu_plugin" filename="gz-sim-imu-system">
      <link_name>imu_link</link_name>
      <topic>/imu</topic>
      <update_rate>200</update_rate>
    </plugin>
  </xacro:macro>

  <!-- Inertial helpers -->
  <xacro:macro name="box_inertial" params="x y z mass">
    <inertial>
      <mass value="${mass}"/>
      <origin xyz="0 0 0"/>
      <inertia ixx="${0.0833333 * mass * (y*y + z*z)}"
               iyy="${0.0833333 * mass * (x*x + z*z)}"
               izz="${0.0833333 * mass * (x*x + y*y)}"
               ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </xacro:macro>

  <xacro:macro name="cylinder_inertial" params="radius length mass">
    <inertial>
      <mass value="${mass}"/>
      <origin xyz="0 0 0"/>
      <inertia ixx="${0.0833333 * mass * (3 * radius * radius + length * length)}"
               iyy="${0.0833333 * mass * (3 * radius * radius + length * length)}"
               izz="${0.5 * mass * radius * radius}"
               ixy="0" ixz="0" iyz="0"/>
    </inertial>
  </xacro:macro>

</robot>
